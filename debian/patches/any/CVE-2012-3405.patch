Origin: http://sourceware.org/git/?p=glibc.git;a=commitdiff;h=a4647e727a2a52e1259474c13f4b13288938bed4
From a4647e727a2a52e1259474c13f4b13288938bed4 Mon Sep 17 00:00:00 2001
From: Ulrich Drepper <drepper@gmail.com>
Date: Sat, 17 Dec 2011 21:27:25 -0500
Subject: [PATCH] Fix extension of array in extended printf format handling

2011-12-17  Ulrich Drepper  <drepper@gmail.com>

	[BZ #13446]
	* stdio-common/vfprintf.c (vfprintf): Fix extension of specs array.

CVE-2012-3405

---
 stdio-common/vfprintf.c |   13 ++++++-------
 3 files changed, 13 insertions(+), 9 deletions(-)

Index: glibc-2.7/stdio-common/vfprintf.c
===================================================================
--- glibc-2.7.orig/stdio-common/vfprintf.c	2012-09-26 14:34:20.000000000 -0700
+++ glibc-2.7/stdio-common/vfprintf.c	2012-09-26 16:00:25.000000000 -0700
@@ -1622,9 +1622,9 @@
     /* Array with information about the needed arguments.  This has to
        be dynamically extensible.  */
     size_t nspecs = 0;
-    size_t nspecs_max = 32;	/* A more or less arbitrary start value.  */
-    struct printf_spec *specs
-      = alloca (nspecs_max * sizeof (struct printf_spec));
+    /* A more or less arbitrary start value.  */
+    size_t nspecs_size = 32 * sizeof (struct printf_spec);
+    struct printf_spec *specs = alloca (nspecs_size);
 
     /* The number of arguments the format string requests.  This will
        determine the size of the array needed to store the argument
@@ -1661,15 +1661,14 @@
 
     for (f = lead_str_end; *f != L_('\0'); f = specs[nspecs++].next_fmt)
       {
-	if (nspecs >= nspecs_max)
+	if (nspecs * sizeof (*specs) >= nspecs_size)
 	  {
 	    /* Extend the array of format specifiers.  */
 	    struct printf_spec *old = specs;
-	    specs = extend_alloca (specs, nspecs_max,
-				   2 * nspecs_max * sizeof (*specs));
+	    specs = extend_alloca (specs, nspecs_size, 2 * nspecs_size);
  
  	    /* Copy the old array's elements to the new space.  */
- 	    memmove (specs, old, nspecs * sizeof (struct printf_spec));
+	    memmove (specs, old, nspecs * sizeof (*specs));
 	  }
 
 	/* Parse the format specifier.  */
