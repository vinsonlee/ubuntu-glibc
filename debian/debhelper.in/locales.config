#!/bin/sh
set -e

. /usr/share/debconf/confmodule
db_version 2.0
db_capb backup multiselect

#   Initializes debconf default values from the ones found in
#   configuration files
SELECTED_LOCALES=
if [ -L /etc/locale.gen ] && [ "$(readlink /etc/locale.gen)" = /usr/share/i18n/SUPPORTED ]; then
    SELECTED_LOCALES="All locales"
    LG=/dev/null
elif [ -e /etc/locale.gen ]; then
    LG=/etc/locale.gen
    #  Debconf templates in locales < 2.3.2 were completely different,
    #  the locales/locales_to_be_generated question could have a "Leave alone"
    #  value in which case locale-gen was not run.
    #  With current implementation, this string has to be removed.
    grep -q "Leave alone" $LG && sed -e '/^Leave alone/d' $LG > $LG.tmp && mv $LG.tmp $LG

    SELECTED_LOCALES=$(LC_ALL=C sed -e '/^[a-zA-Z]/!d' $LG | tr '\n' ',' | sed -e 's/,/, /g' -e 's/, *$//')
else
    LG=/dev/null
fi
DEFAULT_ENVIRONMENT=$(cat /etc/environment /etc/default/locale 2>/dev/null | awk 'BEGIN {lang="None"} /^LANG=/ {gsub("\"", ""); sub("LANG=", ""); lang=$0;} END {print lang}')
[ -n "$DEFAULT_ENVIRONMENT" ] || DEFAULT_ENVIRONMENT=None

#   Add a newline in case /etc/locale.gen has no trailing newline at EOF
SUPPORTED_LOCALES="
__SUPPORTED_LOCALES__"
SUPPORTED_LOCALES=$( (cat $LG && echo "$SUPPORTED_LOCALES") | LC_ALL=C sed -e '/^[a-zA-Z]/!d' | LC_ALL=C sort -u | tr '\n' ',' | sed -e 's/,/, /g' -e 's/, *$//')

if [ -z "$DEBCONF_IS_A_REGISTRY" ] && [ -e /etc/locale.gen ]; then
    db_set locales/locales_to_be_generated "${SELECTED_LOCALES}"
    db_set locales/default_environment_locale "$DEFAULT_ENVIRONMENT"
fi
db_subst locales/locales_to_be_generated locales "${SUPPORTED_LOCALES}"

STATE=1
while [ "$STATE" -ge 0 ]; do
    case "$STATE" in
    0)
        exit 1
        ;;
    1)
        db_input medium locales/locales_to_be_generated || true
        ;;
    2)
        db_get locales/locales_to_be_generated || RET=
        if expr ", $RET," : ".*, None,.*" >/dev/null 2>&1; then
            # "None" was a choice in older packages
            db_set locales/locales_to_be_generated ""
            RET=
        elif expr ", $RET," : ".*, All locales,.*" >/dev/null 2>&1; then
            # When "All locales" is selected, other choices have to be dropped
            db_set locales/locales_to_be_generated "All locales"
            RET=$SUPPORTED_LOCALES
        fi
        DEFAULT_LOCALES=$(echo $RET | sed -e 's/ [^ ]*,/,/g' -e 's/ [^ ]*$//')
        if [ -n "$DEFAULT_LOCALES" ]; then
            db_subst locales/default_environment_locale locales $DEFAULT_LOCALES
            db_input medium locales/default_environment_locale || true
        fi
        ;;
    *)
        break
        ;;
    esac
    if db_go; then
        STATE=$(($STATE + 1))
    else
        STATE=$(($STATE - 1))
    fi
done
